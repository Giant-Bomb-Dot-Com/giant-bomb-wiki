local p = {}

function p.render(frame)
    local args = frame.args
    local parentArgs = frame:getParent() and frame:getParent().args or {}
    local rawLetter = args.chosen_letter or parentArgs.chosen_letter or "All"
    local currentLetter = mw.uri.decode(rawLetter, "WIKI")
    local searchFilter = mw.uri.decode(args.search_filter or parentArgs.search_filter or "","QUERY")

    -- Try to get 'limit' from invoke args, then parent args, then default to 48
    local limit = tonumber(args.limit) or tonumber(parentArgs.limit) or 48
    local offset = tonumber(args.offset) or tonumber(parentArgs.offset) or 0
    
    -- Cleanup: If #urlget failed and returned the literal string, default to All
    if currentLetter:find('{{#urlget') then
        currentLetter = "All"
    end

    local baseQuery = "[[Category:Companies]]"
    
    if currentLetter ~= "All" then
        if currentLetter == "#" then
            -- Query for names starting with any digit 0-9
            baseQuery = baseQuery .. " [[Has name::~[0-9]*]]"
        else
            -- Query for names starting with the specific letter (e.g., "[[Name::~A*]]")
            baseQuery = baseQuery .. " [[Has name::~" .. currentLetter .. "*]]"
        end
    end
    
    -- Because we are doing inverse searches and we have muliple, we have to do each as seperate queries and join the data
    local finalResults = {}
    local seenTitles = {}
	
	-- Filter by Name (using SMW wildcard search)
	local queryTable = { baseQuery }
	    if searchFilter ~= "" then
	        local dbSearch = searchFilter:gsub(" ", "_")
	        queryTable = {
	            baseQuery .. " [[-Has developers::~*" .. dbSearch .. "*]]",
	            baseQuery .. " [[-Has publishers::~*" .. dbSearch .. "*]]"
	        }
    end

    -- Run queries and merge results
    for _, q in ipairs(queryTable) do
        local data = mw.smw.getQueryResult({
            q,
            "?Has image#nowiki",
--        "?Has image raw#nowiki",  --DO WE HAVE TO DO THIS FOR ALL?
            "?-Has developers=DevelopedGames",
            "?-Has publishers=PublishedGames",
            "?Has deck",
	        limit = limit,
	        offset = offset,
	        ["count"] = true
        })
        
        if data and data.results then
            for _, res in ipairs(data.results) do
                if not seenTitles[res.fulltext] then
                    table.insert(finalResults, res)
                    seenTitles[res.fulltext] = true
                end
            end
        end
    end

    -- 3. Debugging / No Results
    if #finalResults == 0 then
        return '<div class="no-results">No companies found.</div>'
    end
    
    table.sort(finalResults, function(a, b) return a.fulltext < b.fulltext end)

    local html = mw.html.create('div'):addClass('listing-grid')
    
    local startIndex = offset + 1
    local endIndex = math.min(offset + limit, #finalResults)
    
    for i = startIndex, endIndex do
        local result = finalResults[i]
  	    local fullTitle = result.fulltext or ""
    	-- This pattern matches "Companies/" or "companies/" at the start
    	local cleanTitle = fullTitle:gsub("^[Cc][Oo][Mm][Pp][Aa][Nn][Ii][Ee][Ss]/", "")
    	
   	    local devGamesCount = result.printouts["DevelopedGames"] and #result.printouts["DevelopedGames"] or 0
        local pubGamesCount = result.printouts["PublishedGames"] and #result.printouts["PublishedGames"] or 0
    	
        -- Helper to extract strings from nested SMW tables
        local function getSafe(field, isList)
            local d = result.printouts[field] or {}
            local vals = {}
            for _, v in ipairs(d) do
                local str = type(v) == "table" and (v.raw or v.fulltext or "") or tostring(v)
                table.insert(vals, str)
            end
            return isList and table.concat(vals, ", ") or (vals[1] or "")
        end

        -- 4. Process Image data from description
        --local imageData = getSafe('Has image raw', false)
        local imageData = getSafe('Has image', false)
        imageData = imageData:gsub("Â¤", "_"):gsub("Http", "http"):gsub(" ", "%%20")

		html:wikitext(frame:expandTemplate{ 
		    title = 'CompanyCard', 
		    args = { 
		        url_title    = fullTitle,
		        title        = cleanTitle,
                developed    = devGamesCount,
                published    = pubGamesCount,
		        deck         = getSafe('Has deck', true),
		        image        = imageData
		    } 
		})
    end

    -- 5. Build Pagination (using queryData.count)
    local totalResults = #finalResults
	local paginationHtml = ""
	if totalResults > 0 then
	    paginationHtml = tostring(mw.html.create('div')
	        :addClass('pagination-wrapper')
	        :attr('data-total', totalResults)
	        :attr('data-limit', limit)
	        :attr('data-offset', offset)
	        :attr('data-letter', currentLetter)
	        :attr('data-search', searchFilter))
	end
	
	return tostring(html) .. paginationHtml
end

return p
